#!/usr/bin/perl
###############################################################################
# Description:
#       Perl CGI Session cleanup script.
#       This is designed to be run periodcially to detect and clean up
#       expired and no longer required Perl CGI Session files.
#
#       Perl CGI Session does not have a native mechanism to do this for us.
#
# Licence:
#       This file is part of the Jarvis WebApp/Database gateway utility.
#
#       Jarvis is free software: you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation, either version 3 of the License, or
#       (at your option) any later version.
#
#       Jarvis is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#
#       You should have received a copy of the GNU General Public License
#       along with Jarvis.  If not, see <http://www.gnu.org/licenses/>.
#
#       This software is Copyright 2022 by Jonathan Couper-Smartt.
###############################################################################
use strict;
use warnings;
use File::Find::Rule;
use CGI::Session;
use Getopt::Long;
use Data::Dumper;
use XML::LibXML;

###############################################################################
# DEFAULTS AND COMMAND LINE FLAGS
###############################################################################
my $jconf_dir           = '/etc/jarvis';
my $session_file_prefix = 'cgisess_';
my $show_help           = 0;
my $debug               = 0;

###############################################################################
# USAGE
###############################################################################
sub usage {
    print STDERR
"usage: clean_sessions.pl

    The purpose of this script is to be periodically run to clean up files generated by Perls CGI Session library.
    This library does not natively have a mechanism for automatically removing generated session files.

    Configurable Flags:
        --jconf-dir         # The directory to check for Jarvis configuration files. Default: /etc/jarvis
        --file-prefix       # Define the file prefix to use when locating CGI session files. Default: cgisess_
        --debug             # Show additional debug log output.
        --help              # Show this help information

";
    exit;
}

###############################################################################
# MAIN
###############################################################################

# Get comand line settings.
&Getopt::Long::GetOptions (
    "jconf-dir=s"     => \$jconf_dir
    , "file-prefix=s" => \$session_file_prefix
    , "debug"         => \$debug
    , "help"          => \$show_help
) || &usage ();

# Asking for help?
if ($show_help) {
    usage ();
}

# Keep a track of all directories we've processed. No point in doign the same multiple times.
my $processed_dirs = {};

# Locate all XML configuration files present in our JConf provided directory.
foreach my $possible_jconf_file (File::Find::Rule->mindepth (1)->maxdepth (1)->file->in ($jconf_dir .'/')) {

    # Not XML?
    next if $possible_jconf_file !~ /\.xml$/;

    $debug && printf ("Parsing Jarvis Config File: %s\n", $possible_jconf_file);

    # Attempt to load the XML configuration file.
    my $xml;
    eval {
        $xml = XML::LibXML->load_xml (location => $possible_jconf_file);
    };

    # Check for XML::LibXML error object.
    if (ref ($@)) {
        # If we have a specific XML::LibXML::Error object then we can pretty print the error.
        my $error_domain  = $@->domain ();
        my $error_message = $@->message ();

        # This might be a bad file. We won't treat it as fatal but lets warn.
        printf ("Cannot Read '%s': [%s] %s\n", $possible_jconf_file, $error_domain, $error_message);
        next;

    # Fall back to default error handling.
    } elsif ($@) {
        # Again it might just be a bad file. We won't treat it as fatal.
        printf ("Cannot Read '%s': %s\n", $possible_jconf_file, $@);
        next;
    }

    # Have a good file? and its valid XML? Lets go ahead and see if we can find our CGI configuration.
    if ($xml->exists ('./jarvis/app/sessiondb')) {
        # Find session config.
        my $session_db = $xml->findnodes ('./jarvis/app/sessiondb')->pop ();

        # Check that we are storing it as a file.
        next if $session_db->{store} !~ /driver:file/;

        # Now check if we have a directory?
        my $session_params;
        if ($session_db->exists ('./parameter')) {
            foreach my $session_param ($session_db->findnodes ('./parameter')) {
                $session_params->{lc ($session_param->{'name'})} = $session_param->{'value'};
            }
        }

        # Have a directory configuration?
        my $session_dir = $session_params->{directory};
        next if ! defined ($session_dir);
        next if defined ($processed_dirs->{$session_dir});
        $processed_dirs->{$session_dir} = 1;

        # Have a valid directory? Ok lets process that directory and look for any session files that might be in there?
        foreach my $file (File::Find::Rule->mindepth (1)->maxdepth (1)->file->in ($session_dir)) {

            # Check if we're looking at a CGI session named file.
            next if $file !~ /^\Q$session_dir\E\/\Q$session_file_prefix\E(.*)/;

            # Next try to load the file content and determine if we are looking at a valid session.
            my $content;
            open (my $fh, '<', $file) or die "cannot open file $file";
            {
                local $/;
                $content = <$fh>;
            }
            close($fh);

            # The CGI sessions are stored as a serialized object with the name 'D'. We can just eval it out into an object.
            # If for whatever reason the session file is invalid this will return undef.
            my $D;
            eval ($content);

            # If we have a valid object go ahead and pull it apart and see if its an expired session.
            if (! defined ($D)) {
                printf ("Unable to read session data in: %s\n", $file);

            } elsif ($D && $D->{_SESSION_ETIME} && $D->{_SESSION_ATIME} && (time () >= $D->{_SESSION_ETIME} + $D->{_SESSION_ATIME})) {
                $debug && printf ("Session %s has Expired. Removing.\n", $file);
                unlink ($file) or printf ("Cannot delete session %s: %s", $file, $!);

            } else {
                $debug && printf ("Session %s Still Valid.\n", $file);
            }
        }

    } else {
        $debug && printf ("Jarvis Config File '%s' does not contain Session DB property.\n", $possible_jconf_file);
        next;
    }
}

$debug && printf ("Cleanup Complete.\n");
1;
